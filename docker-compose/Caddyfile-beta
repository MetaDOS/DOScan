# DOS Chain Beta - Reverse Proxy
# HTTP only - Cloudflare Tunnel handles HTTPS
# Runs locally on WSL2, exposed via cloudflared Windows Service

:80 {
    # Backend API
    handle /api/* {
        reverse_proxy backend:4000
    }

    # WebSocket
    handle /socket/* {
        reverse_proxy backend:4000
    }

    # Sitemap
    handle /sitemap.xml {
        reverse_proxy backend:4000
    }

    # Auth
    handle /auth/* {
        reverse_proxy backend:4000
    }

    # Metrics
    handle /metrics {
        reverse_proxy backend:4000
    }

    # Stats API (path-based)
    handle /stats-api/* {
        uri strip_prefix /stats-api
        header Access-Control-Allow-Origin "https://beta.doscan.io"
        header Access-Control-Allow-Methods "GET, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type"
        @options method OPTIONS
        respond @options 204
        reverse_proxy stats:8050
    }

    # Visualizer API (path-based)
    handle /visualize/* {
        header Access-Control-Allow-Origin "https://beta.doscan.io"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type"
        @vizoptions method OPTIONS
        respond @vizoptions 204
        reverse_proxy visualizer:8050
    }

    # Frontend (default)
    handle {
        reverse_proxy frontend:3000
    }
}
