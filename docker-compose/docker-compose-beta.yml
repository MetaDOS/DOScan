# DOS Chain Mainnet - Block Explorer Beta (Blockscout)
# beta.doscan.io
# Runs locally on WSL2/WRX90, uses external PostgreSQL + AvalancheGo
# Cloudflare Tunnel (Windows Service) handles HTTPS

name: doscan

services:
  # ==========================================================================
  # Cache
  # ==========================================================================
  redis-db:
    container_name: doscan-redis
    image: redis:alpine
    restart: always
    command: redis-server
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Backend - Blockscout Latest
  # ==========================================================================
  backend:
    container_name: doscan-backend
    depends_on:
      redis-db:
        condition: service_healthy
    image: metados/blockscout:latest
    pull_policy: always
    restart: always
    stop_grace_period: 5m
    sysctls:
      - net.ipv4.ip_local_port_range=1024 65535
    command: sh -c 'bin/blockscout eval "Elixir.Explorer.ReleaseTasks.create_and_migrate()" && bin/blockscout start'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - ./envs/common-blockscout.env
      - ./envs/common-blockscout-beta.env
    networks:
      - default
      - avalanchego
    ports:
      - "127.0.0.1:14000:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/v2/stats"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Frontend - DOScan Latest
  # ==========================================================================
  frontend:
    container_name: doscan-frontend
    depends_on:
      backend:
        condition: service_healthy
    image: metados/blockscout-frontend:latest
    pull_policy: always
    restart: always
    env_file:
      - ./envs/common-frontend.env
      - ./envs/common-frontend-beta.env
    ports:
      - "127.0.0.1:13000:3000"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const h=require('http');h.get('http://localhost:3000',r=>{process.exit(r.statusCode===200?0:1)}).on('error',()=>process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Microservices
  # ==========================================================================
  smart-contract-verifier:
    container_name: doscan-verifier
    image: ghcr.io/blockscout/smart-contract-verifier:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    env_file:
      - ./envs/common-smart-contract-verifier.env
    ports:
      - "127.0.0.1:18043:8050"

  visualizer:
    container_name: doscan-visualizer
    image: ghcr.io/blockscout/visualizer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    env_file:
      - ./envs/common-visualizer.env
    ports:
      - "127.0.0.1:18044:8050"

  sig-provider:
    container_name: doscan-sig-provider
    image: ghcr.io/blockscout/sig-provider:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    ports:
      - "127.0.0.1:18045:8050"

  # ==========================================================================
  # User Ops Indexer (ERC-4337 Account Abstraction)
  # ==========================================================================
  user-ops-indexer:
    container_name: doscan-user-ops
    depends_on:
      - backend
    image: ghcr.io/blockscout/user-ops-indexer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      USER_OPS_INDEXER__INDEXER__RPC_URL: "http://host.docker.internal:9650/ext/bc/22v7AG7h6qaVxd4bLvAsSsg2LZ4RCn5iVYgFn7a2Fj1LCuYwjv/rpc"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08: "true"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08_ENTRY_POINT: "0x433709009B8330FDa32311DF1C2AFA402eD8D009"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V06: "false"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V07: "false"
      USER_OPS_INDEXER__DATABASE__CONNECT__URL: "postgresql://JOY:J8p!x2wqZs7vQ4rL@host.docker.internal:5432/doscan"
      USER_OPS_INDEXER__DATABASE__CREATE_DATABASE: "false"
      USER_OPS_INDEXER__DATABASE__RUN_MIGRATIONS: "true"
      USER_OPS_INDEXER__SERVER__HTTP__ADDR: "0.0.0.0:8050"
    ports:
      - "127.0.0.1:18090:8050"

  # ==========================================================================
  # Stats Service
  # ==========================================================================
  stats:
    container_name: doscan-stats
    image: ghcr.io/blockscout/stats:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      STATS__DB_URL: "postgresql://JOY:J8p!x2wqZs7vQ4rL@host.docker.internal:5432/doscan_stats"
      STATS__BLOCKSCOUT_DB_URL: "postgresql://JOY:J8p!x2wqZs7vQ4rL@host.docker.internal:5432/doscan"
      STATS__CREATE_DATABASE: "true"
      STATS__RUN_MIGRATIONS: "true"
      STATS__SERVER__HTTP__ADDR: "0.0.0.0:8050"
      STATS__SERVER__HTTP__CORS__ALLOWED_ORIGIN: "https://beta.doscan.io"
      STATS__IGNORE_BLOCKSCOUT_API_ABSENCE: "true"
    ports:
      - "127.0.0.1:18052:8050"

  # ==========================================================================
  # Caddy - Reverse Proxy (HTTP only, Cloudflare Tunnel handles HTTPS)
  # ==========================================================================
  caddy:
    container_name: doscan-caddy
    depends_on:
      backend:
        condition: service_healthy
    image: caddy:latest
    restart: always
    volumes:
      - ./Caddyfile-beta:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "10080:80"

volumes:
  redis_data:
  caddy_data:
  caddy_config:

networks:
  default:
  avalanchego:
    name: avalanchego_default
    external: true
