# DOS Chain Mainnet - Block Explorer (Blockscout)
# doscan.io
# Deployed on archive VM (20.195.24.239)
# AvalancheGo runs as native systemd service (NOT in this compose)

services:
  # ==========================================================================
  # Database
  # ==========================================================================
  redis-db:
    image: redis:alpine
    container_name: redis-db
    restart: always
    command: redis-server
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3

  db-init:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    entrypoint:
      - sh
      - -c
      - |
        chown -R 2000:2000 /var/lib/postgresql/data

  db:
    depends_on:
      db-init:
        condition: service_completed_successfully
    image: postgres:15
    shm_size: 256m
    restart: always
    container_name: db
    user: 2000:2000
    command: postgres -c 'max_connections=200' -c 'client_connection_check_interval=60000'
    environment:
      POSTGRES_PASSWORD: ""
      POSTGRES_USER: "postgres"
      POSTGRES_HOST_AUTH_METHOD: "trust"
    ports:
      - "127.0.0.1:7432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Backend - Blockscout Latest
  # ==========================================================================
  backend:
    depends_on:
      db:
        condition: service_healthy
      redis-db:
        condition: service_healthy
    image: doscan-backend:latest
    pull_policy: never
    restart: always
    stop_grace_period: 5m
    container_name: backend
    command: sh -c 'bin/blockscout eval "Elixir.Explorer.ReleaseTasks.create_and_migrate()" && bin/blockscout start'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - ./envs/common-blockscout.env
    links:
      - db:database
    ports:
      - "127.0.0.1:4000:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/v2/stats"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Frontend - Blockscout Latest
  # ==========================================================================
  frontend:
    depends_on:
      backend:
        condition: service_healthy
    image: doscan-frontend:latest
    pull_policy: never
    restart: always
    container_name: frontend
    env_file:
      - ./envs/common-frontend.env
    ports:
      - "127.0.0.1:3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # Microservices
  # ==========================================================================
  smart-contract-verifier:
    image: ghcr.io/blockscout/smart-contract-verifier:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: smart-contract-verifier
    env_file:
      - ./envs/common-smart-contract-verifier.env
    ports:
      - "127.0.0.1:8043:8050"

  visualizer:
    image: ghcr.io/blockscout/visualizer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: visualizer
    env_file:
      - ./envs/common-visualizer.env
    ports:
      - "127.0.0.1:8044:8050"

  sig-provider:
    image: ghcr.io/blockscout/sig-provider:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: sig-provider
    ports:
      - "127.0.0.1:8045:8050"

  # ==========================================================================
  # User Ops Indexer (ERC-4337 Account Abstraction)
  # ==========================================================================
  user-ops-indexer:
    depends_on:
      - db
      - backend
    image: ghcr.io/blockscout/user-ops-indexer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: user-ops-indexer
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      USER_OPS_INDEXER__INDEXER__RPC_URL: "http://host.docker.internal:9650/ext/bc/22v7AG7h6qaVxd4bLvAsSsg2LZ4RCn5iVYgFn7a2Fj1LCuYwjv/rpc"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08: "true"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08_ENTRY_POINT: "0x433709009B8330FDa32311DF1C2AFA402eD8D009"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V06: "false"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V07: "false"
      USER_OPS_INDEXER__DATABASE__CONNECT__URL: "postgresql://postgres:@db:5432/blockscout"
      USER_OPS_INDEXER__DATABASE__CREATE_DATABASE: "false"
      USER_OPS_INDEXER__DATABASE__RUN_MIGRATIONS: "true"
      USER_OPS_INDEXER__SERVER__HTTP__ADDR: "0.0.0.0:8090"
    ports:
      - "127.0.0.1:8090:8090"

  # ==========================================================================
  # Stats Service
  # ==========================================================================
  stats:
    depends_on:
      - db
    image: ghcr.io/blockscout/stats:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: stats
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      STATS__DB_URL: "postgresql://postgres:@db:5432/stats"
      STATS__BLOCKSCOUT_DB_URL: "postgresql://postgres:@db:5432/blockscout"
      STATS__CREATE_DATABASE: "true"
      STATS__RUN_MIGRATIONS: "true"
      STATS__SERVER__HTTP__ADDR: "0.0.0.0:8050"
      STATS__SERVER__HTTP__CORS__ALLOWED_ORIGIN: "https://doscan.io"
      STATS__IGNORE_BLOCKSCOUT_API_ABSENCE: "true"
    ports:
      - "127.0.0.1:8052:8050"

  # ==========================================================================
  # Caddy - Reverse Proxy with Cloudflare Origin SSL
  # ==========================================================================
  caddy:
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    image: caddy:latest
    container_name: caddy
    restart: always
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./certs:/etc/caddy/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "80:80"
      - "443:443"

volumes:
  postgres_data:
  redis_data:
  caddy_data:
  caddy_config:
