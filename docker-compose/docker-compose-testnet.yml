# DOS Chain Testnet Explorer - v2
# Combines Builder workflow with custom build
# Domain: test.doscan.io

services:
  # ==========================================================================
  # AvalancheGo Node - syncs L1 chain
  # ==========================================================================
  avago:
    image: avaplatform/subnet-evm_avalanchego:v0.8.0-fuji_v1.14.0-fuji
    container_name: avago
    restart: always
    ports:
      - "127.0.0.1:9650:9650"
      - "9651:9651"
    volumes:
      - avago_data:/root/.avalanchego
    environment:
      AVAGO_PARTIAL_SYNC_PRIMARY_NETWORK: "true"
      AVAGO_PUBLIC_IP_RESOLUTION_SERVICE: "opendns"
      AVAGO_NETWORK_ID: fuji
      AVAGO_HTTP_HOST: "0.0.0.0"
      AVAGO_TRACK_SUBNETS: "ydvj9cWpa5jM7VsHcdzk16KDBqc9us6zuhmTwc7Px6b42ACVN"
      AVAGO_HTTP_ALLOWED_HOSTS: "*"
      # Chain config for DOS Testnet L1
      AVAGO_CHAIN_CONFIG_CONTENT: "eyJlNFBIdGg4dXRCQVBvcmc0c0ZSVGFXbURmVVdmOVg4bkFFQ2N6R3gxQkpWbVlCdjNBIjp7IkNvbmZpZyI6ImV5SndjblZ1YVc1bkxXVnVZV0pzWldRaU9tWmhiSE5sTENKc2IyY3RiR1YyWld3aU9pSmtaV0oxWnlJc0luZGhjbkF0WVhCcExXVnVZV0pzWldRaU9uUnlkV1VzSW1WMGFDMWhjR2x6SWpwYkltVjBhQ0lzSW1WMGFDMW1hV3gwWlhJaUxDSnVaWFFpTENKaFpHMXBiaUlzSW5kbFlqTWlMQ0pwYm5SbGNtNWhiQzFsZEdnaUxDSnBiblJsY201aGJDMWliRzlqYTJOb1lXbHVJaXdpYVc1MFpYSnVZV3d0ZEhKaGJuTmhZM1JwYjI0aUxDSnBiblJsY201aGJDMWtaV0oxWnlJc0ltbHVkR1Z5Ym1Gc0xXRmpZMjkxYm5RaUxDSnBiblJsY201aGJDMXdaWEp6YjI1aGJDSXNJbVJsWW5Wbklpd2laR1ZpZFdjdGRISmhZMlZ5SWl3aVpHVmlkV2N0Wm1sc1pTMTBjbUZqWlhJaUxDSmtaV0oxWnkxb1lXNWtiR1Z5SWwxOSIsIlVwZ3JhZGUiOm51bGx9fQ=="
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9650/ext/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================================================
  # Database
  # ==========================================================================
  redis-db:
    image: redis:alpine
    container_name: redis-db
    restart: always
    command: redis-server
    volumes:
      - redis_data:/data

  db-init:
    image: postgres:15
    entrypoint:
      - sh
      - -c
      - |
        chown -R 999:999 /var/lib/postgresql/data
    volumes:
      - postgres_data:/var/lib/postgresql/data

  db:
    depends_on:
      db-init:
        condition: service_completed_successfully
    image: postgres:15
    shm_size: 256m
    restart: always
    container_name: db
    command: postgres -c 'max_connections=200' -c 'client_connection_check_interval=60000'
    environment:
      POSTGRES_PASSWORD: ""
      POSTGRES_USER: "postgres"
      POSTGRES_HOST_AUTH_METHOD: "trust"
    ports:
      - "7432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # ==========================================================================
  # Backend - Blockscout Latest
  # ==========================================================================
  backend:
    depends_on:
      - db
      - redis-db
      - avago
    image: metados/blockscout:latest
    pull_policy: always
    restart: always
    stop_grace_period: 5m
    container_name: backend
    command: sh -c 'bin/blockscout eval "Elixir.Explorer.ReleaseTasks.create_and_migrate()" && bin/blockscout start'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    env_file:
      - ./envs/common-blockscout.env
      - ./envs/common-blockscout-testnet.env
    links:
      - db:database
    ports:
      - "4000:4000"

  # ==========================================================================
  # Frontend
  # ==========================================================================
  frontend:
    depends_on:
      - backend
    image: metados/blockscout-frontend:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: frontend
    environment:
      - HOSTNAME=0.0.0.0
    env_file:
      - ./envs/common-frontend.env
      - ./envs/common-frontend-testnet.env
    ports:
      - "3000:3000"

  # ==========================================================================
  # Microservices
  # ==========================================================================
  smart-contract-verifier:
    image: ghcr.io/blockscout/smart-contract-verifier:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: smart-contract-verifier
    env_file:
      - ./envs/common-smart-contract-verifier.env
    ports:
      - "8043:8050"

  visualizer:
    image: ghcr.io/blockscout/visualizer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: visualizer
    env_file:
      - ./envs/common-visualizer.env
    ports:
      - "8044:8050"

  sig-provider:
    image: ghcr.io/blockscout/sig-provider:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: sig-provider
    ports:
      - "8045:8050"

  user-ops-indexer:
    depends_on:
      - db
      - avago
    image: ghcr.io/blockscout/user-ops-indexer:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: user-ops-indexer
    environment:
      USER_OPS_INDEXER__INDEXER__RPC_URL: http://avago:9650/ext/bc/e4PHth8utBAPorg4sFRTaWmDfUWf9X8nAECczGx1BJVmYBv3A/rpc
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08: "true"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V08_ENTRY_POINT: "0x433709009B8330FDa32311DF1C2AFA402eD8D009"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V06: "false"
      USER_OPS_INDEXER__INDEXER__ENTRYPOINTS__V07: "false"
      USER_OPS_INDEXER__DATABASE__CONNECT__URL: postgresql://postgres:@db:5432/blockscout
      USER_OPS_INDEXER__DATABASE__CREATE_DATABASE: "false"
      USER_OPS_INDEXER__DATABASE__RUN_MIGRATIONS: "true"
      USER_OPS_INDEXER__SERVER__HTTP__ADDR: "0.0.0.0:8050"
    ports:
      - "8090:8050"

  # ==========================================================================
  # Stats Service
  # ==========================================================================
  stats:
    depends_on:
      - db
    image: ghcr.io/blockscout/stats:latest
    pull_policy: always
    platform: linux/amd64
    restart: always
    container_name: stats
    environment:
      STATS__DB_URL: "postgresql://postgres:@db:5432/stats"
      STATS__BLOCKSCOUT_DB_URL: "postgresql://postgres:@db:5432/blockscout"
      STATS__CREATE_DATABASE: "true"
      STATS__RUN_MIGRATIONS: "true"
      STATS__SERVER__HTTP__ADDR: "0.0.0.0:8050"
      STATS__SERVER__HTTP__CORS__ALLOWED_ORIGIN: "https://test.doscan.io"
      STATS__IGNORE_BLOCKSCOUT_API_ABSENCE: "true"
    ports:
      - "127.0.0.1:8052:8050"

  # Note: Caddy removed - dev VM uses nginx as reverse proxy

volumes:
  postgres_data:
  redis_data:
  avago_data:
